function procesMultipleSelects(){each(stats,function(t,a){schema[a]&&("multipleSelect"!=schema[a].type&&"polities"!=schema[a].type||each(data,function(t,e){e[a]&&(e[a]=e[a].split(","))}))})}function processPercentages(){each(stats,function(t,a){schema[a]&&"percent"==schema[a].type&&each(data,function(t,e){e[a]&&Math.round(e[a]=e[a]/100).toFixed(2)})})}function processNumbers(){each(stats,function(t,a){schema[a]&&("number"!=schema[a].type&&"currency"!=schema[a].type||each(data,function(t,e){e[a]&&(e[a]=numeral(e[a]).value())}))})}function chooseColors(t,a,e){colors="index"==e||"number"==e||"percent"==e||"currency"==e?d3.scale.linear().domain([t,a]).range([lightColor,darkColor]):"rank"==e?d3.scale.linear().domain([t,a]).range([darkColor,lightColor]):"singleSelect"==TypeError?d3.scale.category20b():"verbose"==e||"code"==e?function(){return mediumColor}:"multipleSelect"==e?function(){return mediumDarkColor}:d3.scale.category20b()}function getData(){$.ajax({url:"data/polities.csv"}).done(function(t){stats=Papa.parse(t,{delimiter:"",newline:"",dynamicTyping:!0,preview:1}).data[0],parsed=Papa.parse(t,{delimiter:"",newline:"",header:!0,dynamicTyping:!0,preview:0});var a=[];each(parsed.data,function(t,e){data[e[iDColumnHeader]]=e,a.push([e.name,e[iDColumnHeader]])}),a.sort(function(t,a){return t[0]-a[0]}),each(a,function(t,a){polities.push(a[1])}),gettingData.resolve()})}function getSchema(){$.ajax({url:"data/schema.csv"}).done(function(t){parsed=Papa.parse(t,{delimiter:"",newline:"",header:!0,dynamicTyping:!0,preview:0}),each(parsed.data,function(t,a){schema[a.stat]=a,actualStatSections.push(a.section)}),actualStatSections=unique(actualStatSections),additionalStatSections=_.difference(actualStatSections,idealStatSections),orderedStatSections=idealStatSections.concat(additionalStatSections),gettingSchema.resolve()})}function showMap(){mapDisplay=new Datamap({element:document.getElementById("map"),projection:mapProjection,fills:{defaultFill:defaultFillColor},data:data,geographyConfig:{popupTemplate:function(t,a){return['<div class="hoverinfo"><strong>',a.name,": "+a[setColorsByStat],"</strong></div>"].join("")},highlightFillColor:highlightColor,highlightBorderColor:highlightBorderColor,highlightBorderWidth:1,highlightBorderOpacity:1},projectionConfig:{rotation:[0,0]}}),mapDisplay.legend(),showingMap.resolve()}function setColorsBy(t,a){currentStat=t,a?$("#stats-pane-modifier").show():$("#stats-pane-modifier").hide();var e={},i=[],n,o,s=schema[t].type;"verbose"==schema[t].type?a?each(a,function(t,a){e[a[1]]=colors(a[0])}):each(data,function(a,i){i[t]&&(e[a]=mediumColor)}):(each(data,function(a,e){e[t]&&i.push(e[t])}),n=schema[t].min?schema[t].min:Math.min.apply(null,i),o=schema[t].max?schema[t].max:Math.max.apply(null,i),chooseColors(n,o,s),a?each(a,function(t,a){e[a[1]]=colors(a[0])}):each(data,function(a,i){i[t]&&(e[a]=colors(i[t]))})),mapDisplay.updateChoropleth(e,{reset:!0})}function clearMapColors(){var t={};each(data,function(a,e){t[a]=defaultFillColor}),mapDisplay.updateChoropleth(t,{reset:!0})}function populateStatsList(){each(orderedStatSections,function(t,a){var e=!1;each(stats,function(t,i){if(schema[i]&&schema[i].section==a){if(0==e){var n="<h3>"+a+"</h3>";$("#stats-list").append(n),e=!0}var o;o=schema[i]?schema[i].title:'"'+i+'"';var s="<li class='actionable stat stat-"+i+"'>"+o+"</li>";$("#stats-list").append(s),$(".stat-"+i).click(function(){})}})}),makeStatsInteractive("#stats-list")}function showStatsList(){$("#stats-info").hide(),$("#stats-list").show(),$("#stats-back-text").hide(),$("#stats-source").html(""),$("#stats-pane-title").html("Stats")}function formatStatData(t,a){return"percent"==a?numeral(t).format("0[.]00%"):"currency"==a?numeral(t).format("$0,0[.]00"):"number"==a?numeral(t).format("0,0[.]00"):"polities"==a&&data[t]?data[t].name:t}function displayStatItem(t){var a=formatStatData(t.data,t.type),e="";t.actionable&&(e=e.concat("actionable ")),e=e.concat("stat-"+t.stat+"-data"),$(t.target).append(t.prefix+"<span class='"+e+"' data='"+t.data+"'>"+a+"</span>"),$(t.target).append(t.prefix+sculpt({element:"span",content:a,class:e,data:t.data}))}function showPolityInfo(t){$("#polity-list").hide(),$("#polity-info").empty(),$("#polity-info").show(),$("#polity-back-text").show(),$("#polity-pane-title").html(data[t].name),each(data[t],function(a,e){if(data[t]){var i;i=schema[a]?schema[a].title:'"'+a+'"';var n="#polity-info";schema[a]&&"Codes"!=schema[a].section&&"name"!=a&&e&&($(n).append("<h3 class='actionable stat-"+a+"'>"+i+"</h3>"),"multipleSelect"==schema[a].type||"polities"==schema[a].type?each(e,function(t,i){var o="";0!=t&&(o=", "),displayStatItem({target:n,prefix:o,actionable:!0,stat:a,data:e,type:schema[a].type})}):displayStatItem({target:n,prefix:"",actionable:!0,stat:a,data:e,type:schema[a].type}))}}),makePolitiesInteractive("#polity-info"),makeStatsInteractive("#polity-info"),$("#polity-pane").animate({scrollTop:0},0)}function showStatsInfo(t,a,e){$("#stats-list").hide(),$("#stats-info").empty(),$("#stats-info").show(),$("#stats-back-text").show(),$("#stats-pane-title").html(schema[t].title),each(data,function(i,n){if(n[t]){var o=formatStatData(n[t],schema[t].type);a?"greater"==e&&n[t]>=a?$("#stats-info").append("<h3 class='header actionable "+i+"'>"+n.name+"</h3><div>"+o+"</div>"):"lesser"==e&&n[t]<=a?$("#stats-info").append("<h3 class='header actionable "+i+"'>"+n.name+"</h3><div>"+o+"</div>"):"same"==e&&containsOrEquals(n[t],a)&&$("#stats-info").append("<h3 class='header actionable "+i+"'>"+n.name+"</h3><div>"+o+"</div>"):$("#stats-info").append("<h3 class='header actionable "+i+"'>"+n.name+"</h3><div>"+o+"</div>")}}),makeStatsInteractive("#stats-info"),makePolitiesInteractive("#stats-info"),$("#stats-pane").animate({scrollTop:0},0),showStatsSource(t)}function populatePolitiesList(){each(polities,function(t,a){$("#polity-list").append("<li class='polity actionable "+a+"'>"+data[a].name+"</li>")}),makePolitiesInteractive("#polity-list")}function showPolitiesList(){$("#polity-info").hide(),$("#polity-list").show(),$("#polity-back-text").hide(),$("#polity-pane-title").html("Polities")}function enableBackButtons(){$("#polity-back").click(function(){showPolitiesList()}),$("#stats-back").click(function(){showStatsList(),$("#stats-pane-modifier").hide()})}function showDefaultPolity(){if(defaultPolity)if("random"==defaultPolity){var t=pick(polities);showPolityInfo(t)}else showPolityInfo(defaultPolity)}function makePolitiesInteractive(t){var a="";t&&(a=t+" "),each(polities,function(t,e){$(a+"."+e).click(function(){showPolityInfo(e)}),$(a+"."+e).hover(function(){$("#display").html("<h2>"+data[e].name+"</h2>")})})}function makeStatsInteractive(t){var a="";t&&(a=t+" "),each(stats,function(t,e){$(a+".stat-"+e).click(function(){setColorsBy(e),showStatsInfo(e)})}),each(stats,function(t,e){$(a+".stat-"+e+"-data").click(function(){var t=$(this).attr("data");setColorsBySubset(e,t)})})}function enableZoom(){var t=d3.behavior.zoom().scaleExtent([1,20]).on("zoom",zoomed);d3.select(".datamap").call(t)}function zoomed(){d3.select(".datamaps-subunits").attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")}function setColorsBySubset(t,a){var e=[];"multipleSelect"==schema[t].type||"singleSelect"==schema[t].type?(each(polities,function(i,n){containsOrEquals(data[n][t],a)&&e.push([data[n][t],n]),currentDirection="same",$("#stats-pane-modifier").html(a)}),setColorsBy(t,e),showStatsInfo(t,a,currentDirection)):(a=numeral(a).value(),formattedLimit=formatStatData(a,schema[t].type),t==currentStat&&"greater"==currentDirection?each(polities,function(i,n){""!=data[n][t]&&data[n][t]<=a&&e.push([data[n][t],n]),currentDirection="lesser",$("#stats-pane-modifier").html("&le; "+formattedLimit)}):each(polities,function(i,n){""!=data[n][t]&&data[n][t]>=a&&e.push([data[n][t],n]),currentDirection="greater",$("#stats-pane-modifier").html("&ge; "+formattedLimit)}),e.sort(function(t,a){return t[0]-a[0]}),setColorsBy(t,e),showStatsInfo(t,a,currentDirection))}function enableNavBar(){$("#polities-nav").click(function(){$(".nav-item").removeClass("current-nav"),$(this).addClass("current-nav"),$("#left").removeClass("narrow-hide"),$("#center").addClass("narrow-hide"),$("#right").addClass("narrow-hide")}),$("#map-nav").click(function(){$(".nav-item").removeClass("current-nav"),$(this).addClass("current-nav"),$("#left").addClass("narrow-hide"),$("#center").removeClass("narrow-hide"),$("#right").addClass("narrow-hide")}),$("#stats-nav").click(function(){$(".nav-item").removeClass("current-nav"),$(this).addClass("current-nav"),$("#left").addClass("narrow-hide"),$("#center").addClass("narrow-hide"),$("#right").removeClass("narrow-hide")})}function showStatsSource(t){$("#lower-right").show();var a=schema[t].sourceName,e=schema[t].sourceURL;$("#stats-source").html("Source: "+sculpt({element:"a",content:a,target:"_blank",class:"actionable",href:e}))}$(function(){getData(),getSchema(),enableNavBar()});var csv,data={},schema={},stats=[],colors,polities=[],mapDisplay,currentPolity,currentStat,currentDirection,idealStatSections=["Naming","Demographics","Economy","Infrastructure","Codes"],actualStatSections=[],additionalStatSections=[],orderedStatSections,gettingData=$.Deferred(),gettingSchema=$.Deferred();$.when(gettingData,gettingSchema).done(function(t){procesMultipleSelects(),processPercentages(),processNumbers(),showMap(),populateStatsList(),showStatsList(),populatePolitiesList()});var showingMap=$.Deferred().done(function(){makePolitiesInteractive("#map-pane"),enableZoom(),enableBackButtons()});