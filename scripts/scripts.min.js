function getSettings(){$.ajax({url:"settings.json",dataType:"json",type:"GET"}).done(function(t){app.settings=t,gettingSettings.resolve()})}function getData(){$.ajax({url:"data/polities.csv"}).done(function(t){app.stats=Papa.parse(t,{delimiter:"",newline:"",dynamicTyping:!0,preview:1}).data[0],parsed=Papa.parse(t,{delimiter:"",newline:"",header:!0,dynamicTyping:!0,preview:0});var e=[];each(parsed.data,function(t,a){app.content[a[app.settings.iDColumnHeader]]=a,e.push([a.name,a[app.settings.iDColumnHeader]])}),e.sort(function(t,e){return t[0]===e[0]?0:t[0]<e[0]?-1:1}),each(e,function(t,e){app.polities.push(e[1])}),gettingData.resolve()})}function processData(){each(app.stats,function(t,e){app.schema[e]&&each(app.content,function(t,a){"multipleSelect"==app.schema[e].type||"polities"==app.schema[e].type?a[e]&&(a[e]=a[e].split(",")):"percent"==app.schema[e].type?a[e]&&Math.round(a[e]=a[e]/100).toFixed(2):"number"!=app.schema[e].type&&"currency"!=app.schema[e].type||a[e]&&(a[e]=numeral(a[e]).value())})})}function getSchema(){$.ajax({url:"data/schema.csv"}).done(function(t){parsed=Papa.parse(t,{delimiter:"",newline:"",header:!0,dynamicTyping:!0,preview:0}),each(parsed.data,function(t,e){app.schema[e.stat]=e,app.actualStatSections.push(e.section)}),app.actualStatSections=unique(app.actualStatSections),app.additionalStatSections=_.difference(app.actualStatSections,app.firstStatSections),app.orderedStatSections=app.firstStatSections.concat(app.additionalStatSections),gettingSchema.resolve()})}function showMap(){mapDisplay=new Datamap({element:document.getElementById("map"),projection:app.settings.mapProjection,fills:{defaultFill:app.settings.colors.defaultFill},data:app.content,geographyConfig:{popupOnHover:!1,highlightOnHover:!1,highlightFillColor:app.settings.colors.highlight,highlightBorderColor:app.settings.colors.highlightBorder,highlightBorderWidth:1,highlightBorderOpacity:1},projectionConfig:{rotation:[0,0]},done:function(t){t.svg.selectAll(".datamaps-subunit").on("click",function(t){app.showPolityInfo(t.id)})}}),mapDisplay.legend(),showingMap.resolve()}function scrollUp(t){$(t).animate({scrollTop:0},0)}function enableZoom(){var t=d3.behavior.zoom().scaleExtent([1,20]).on("zoom",zoomed);d3.select(".datamap").call(t)}function zoomed(){d3.select(".datamaps-subunits").attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")}$(function(){getSettings()});var csv,mapDisplay,gettingSettings=$.Deferred(),gettingData=$.Deferred(),gettingSchema=$.Deferred();$.when(gettingSettings).done(function(){getData(),getSchema()}),$.when(gettingData,gettingSchema).done(function(t){processData(),showMap()});var showingMap=$.Deferred().done(function(){enableZoom()});