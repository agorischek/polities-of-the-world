function procesMultipleSelects(){each(app.stats,function(t,e){app.schema[e]&&("multipleSelect"!=app.schema[e].type&&"polities"!=app.schema[e].type||each(app.content,function(t,r){r[e]&&(r[e]=r[e].split(","))}))})}function processPercentages(){each(app.stats,function(t,e){app.schema[e]&&"percent"==app.schema[e].type&&each(app.content,function(t,r){r[e]&&Math.round(r[e]=r[e]/100).toFixed(2)})})}function processNumbers(){each(app.stats,function(t,e){app.schema[e]&&("number"!=app.schema[e].type&&"currency"!=app.schema[e].type||each(app.content,function(t,r){r[e]&&(r[e]=numeral(r[e]).value())}))})}function getData(){$.ajax({url:"data/polities.csv"}).done(function(t){app.stats=Papa.parse(t,{delimiter:"",newline:"",dynamicTyping:!0,preview:1}).data[0],parsed=Papa.parse(t,{delimiter:"",newline:"",header:!0,dynamicTyping:!0,preview:0});var e=[];each(parsed.data,function(t,r){app.content[r[iDColumnHeader]]=r,e.push([r.name,r[iDColumnHeader]])}),e.sort(function(t,e){return t[0]===e[0]?0:t[0]<e[0]?-1:1}),each(e,function(t,e){app.polities.push(e[1])}),gettingData.resolve()})}function getSchema(){$.ajax({url:"data/schema.csv"}).done(function(t){parsed=Papa.parse(t,{delimiter:"",newline:"",header:!0,dynamicTyping:!0,preview:0}),each(parsed.data,function(t,e){app.schema[e.stat]=e,actualStatSections.push(e.section)}),actualStatSections=unique(actualStatSections),additionalStatSections=_.difference(actualStatSections,firstStatSections),app.orderedStatSections=firstStatSections.concat(additionalStatSections),gettingSchema.resolve()})}function showMap(){mapDisplay=new Datamap({element:document.getElementById("map"),projection:mapProjection,fills:{defaultFill:defaultFillColor},data:app.content,geographyConfig:{highlightFillColor:highlightColor,highlightBorderColor:highlightBorderColor,highlightBorderWidth:1,highlightBorderOpacity:1},projectionConfig:{rotation:[0,0]},done:function(t){t.svg.selectAll(".datamaps-subunit").on("click",function(t){app.showPolityInfo(t.id)})}}),mapDisplay.legend(),showingMap.resolve()}function formatStatData(t,e){return"percent"==e?numeral(t).format("0[.]00%"):"currency"==e?numeral(t).format("$0,0[.]00"):"number"==e?numeral(t).format("0,0[.]00"):"polities"==e&&app.content[t]?app.content[t].name:t}function scrollUp(t){$(t).animate({scrollTop:0},0)}function enableZoom(){var t=d3.behavior.zoom().scaleExtent([1,20]).on("zoom",zoomed);d3.select(".datamap").call(t)}function zoomed(){d3.select(".datamaps-subunits").attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")}$(function(){getData(),getSchema()});var csv,colors=d3.scale.category20b(),mapDisplay,app=new Vue({el:"#app",data:{content:{},schema:{},stats:[],strings:strings,polities:[],orderedStatSections:[],currentPolity:null,currentStat:null,currentLimit:null,currentFilter:null,showDebug:!1,currentView:"map"},methods:{politySelect:function(t){this.showPolityInfo(t)},statSelect:function(t){this.showStatsInfo(t),this.currentLimit=null,this.currentFilter=null},polityBack:function(){this.showPolitiesList()},statBack:function(){this.showStatsList()},statSelectWithLimit:function(t,e){this.showStatsInfo(t),this.currentLimit=e,this.changeFilter()},showPolitiesList:function(){this.currentPolity=null,scrollUp("#middle-left")},showStatsList:function(){this.currentStat=null,scrollUp("#middle-right")},showPolityInfo:function(t){this.currentPolity=t,scrollUp("#middle-left")},showStatsInfo:function(t){this.currentStat=t,scrollUp("#middle-right")},hideDebug:function(){this.showDebug=!1},showDebug:function(){this.showDebug=!0},changeFilter:function(){app.currentFilterIndex+1>=app.currentPossibleFilters.length?app.currentFilter=app.currentPossibleFilters[0]:app.currentFilter=app.currentPossibleFilters[app.currentFilterIndex+1]},filterStatItem:function(t){return!!this.currentStatsInfo[t]&&(null==this.currentLimit||(this.currentStatIsNumeric?!!("greaterThanOrEqual"==this.currentFilter&&this.currentStatsInfo[t]>=this.currentLimit&&this.currentLimit)||!!("lessThanOrEqual"==this.currentFilter&&this.currentStatsInfo[t]<=this.currentLimit&&this.currentLimit):"equal"==this.currentFilter&&this.currentLimit==this.currentStatsInfo[t]||"notEqual"==this.currentFilter&&this.currentLimit!=this.currentStatsInfo[t]))}},watch:{currentColors:function(){mapDisplay.updateChoropleth(this.currentColors,{reset:!0})}},computed:{currentStatType:function(){return this.schema[this.currentStat]?this.schema[this.currentStat].type:null},currentPolityInfo:function(){var t={};return this.currentPolity&&(t=this.content[this.currentPolity]),t},currentPolityInfoFormatted:function(){var t={};return each(this.currentPolityInfo,function(e,r){var n="";app.schema[e]&&(n=app.schema[e].type),t[e]=formatStatData(r,n)}),t},currentStatsInfo:function(){var t={};return this.currentStat&&each(this.polities,function(e,r){t[r]=app.content[r][app.currentStat]}),t},currentStatsInfoFiltered:function(){var t={};return each(this.currentStatsInfo,function(e,r){app.filterStatItem(e)&&(t[e]=r)}),t},currentStatsInfoFormatted:function(){var t={},e=this.currentStatType;return each(this.currentStatsInfo,function(r,n){t[r]=formatStatData(n,e)}),t},currentPolityName:function(){if(this.currentPolity)return this.currentPolityInfo.name},currentStatName:function(){if(this.schema[this.currentStat])return this.schema[this.currentStat].title},polityPaneTitle:function(){return this.currentPolity?this.currentPolityName:this.strings.polityPaneTitle},statsPaneTitle:function(){return this.currentStat?this.currentStatName:this.strings.statsPaneTitle},currentLimitFormatted:function(){return null==this.currentLimit?null:formatStatData(this.currentLimit,this.currentStatType)},currentStatIsNumeric:function(){return null==this.currentStatType?null:"index"==this.currentStatType||"number"==this.currentStatType||"percent"==this.currentStatType||"currency"==this.currentStatType||"rank"==this.currentStatType||("singleSelect"==this.currentStatType||"verbose"==this.currentStatType||"code"==this.currentStatType||this.currentStatType,!1)},currentPossibleFilters:function(){return this.currentStat?this.currentStatIsNumeric?["greaterThanOrEqual","lessThanOrEqual"]:this.currentStatIsNumeric?null:["equal","notEqual"]:null},currentFilterIndex:function(){return this.currentStat?this.currentPossibleFilters.indexOf(this.currentFilter):null},currentStatArray:function(){var t=[];return each(this.currentStatsInfo,function(e,r){r&&""!=r&&t.push(r)}),t},currentStatMin:function(){return this.currentStat?(log(this.schema),log(this.currentStat),log(this.schema[this.currentStat]),log(this.schema[this.currentStat].min),null!=this.schema[this.currentStat].min&&""!=this.schema[this.currentStat].min?(log("Returned the schema min"),this.schema[this.currentStat].min):(log("Returned the array min"),Math.min.apply(null,this.currentStatArray))):null},currentStatMax:function(){return this.currentStat?null!=this.schema[this.currentStat].max&&""!=this.schema[this.currentStat].max?this.schema[this.currentStat].max:Math.max.apply(null,this.currentStatArray):null},currentSourceName:function(){return this.currentStat?this.schema[this.currentStat].sourceName:null},currentSourceURL:function(){return this.currentStat?this.schema[this.currentStat].sourceURL:null},filterApplied:function(){return this.currentStat?!!this.currentLimit:null},currentColorScale:function(){var t=this.currentStatType,e=this.currentStatMin,r=this.currentStatMax;return this.currentStat?"index"==t||"number"==t||"percent"==t||"currency"==t?d3.scale.linear().domain([e,r]).range([lightColor,darkColor]):"rank"==t?d3.scale.linear().domain([e,r]).range([darkColor,lightColor]):"singleSelect"==TypeError?d3.scale.category20b():"verbose"==t||"code"==t?function(){return mediumColor}:"multipleSelect"==t?function(){return mediumDarkColor}:d3.scale.category20b():null},currentColors:function(){return this.currentStat?(info={},each(this.currentStatsInfoFiltered,function(t,e){info[t]=app.currentColorScale(e)}),info):null}}}),firstStatSections=["Naming","Demographics","Economy","Infrastructure"],actualStatSections=[],additionalStatSections=[],gettingData=$.Deferred(),gettingSchema=$.Deferred();$.when(gettingData,gettingSchema).done(function(t){procesMultipleSelects(),processPercentages(),processNumbers(),showMap()});var showingMap=$.Deferred().done(function(){enableZoom()});