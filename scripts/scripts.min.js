function procesMultipleSelects(){each(app.stats,function(t,e){app.schema[e]&&("multipleSelect"!=app.schema[e].type&&"polities"!=app.schema[e].type||each(app.content,function(t,a){a[e]&&(a[e]=a[e].split(","))}))})}function processPercentages(){each(app.stats,function(t,e){app.schema[e]&&"percent"==app.schema[e].type&&each(app.content,function(t,a){a[e]&&Math.round(a[e]=a[e]/100).toFixed(2)})})}function processNumbers(){each(app.stats,function(t,e){app.schema[e]&&("number"!=app.schema[e].type&&"currency"!=app.schema[e].type||each(app.content,function(t,a){a[e]&&(a[e]=numeral(a[e]).value())}))})}function chooseColors(t,e,a){colors="index"==a||"number"==a||"percent"==a||"currency"==a?d3.scale.linear().domain([t,e]).range([lightColor,darkColor]):"rank"==a?d3.scale.linear().domain([t,e]).range([darkColor,lightColor]):"singleSelect"==TypeError?d3.scale.category20b():"verbose"==a||"code"==a?function(){return mediumColor}:"multipleSelect"==a?function(){return mediumDarkColor}:d3.scale.category20b()}function getData(){$.ajax({url:"data/polities.csv"}).done(function(t){app.stats=Papa.parse(t,{delimiter:"",newline:"",dynamicTyping:!0,preview:1}).data[0],parsed=Papa.parse(t,{delimiter:"",newline:"",header:!0,dynamicTyping:!0,preview:0});var e=[];each(parsed.data,function(t,a){app.content[a[iDColumnHeader]]=a,e.push([a.name,a[iDColumnHeader]])}),e.sort(function(t,e){return t[0]-e[0]}),each(e,function(t,e){polities.push(e[1])}),gettingData.resolve()})}function getSchema(){$.ajax({url:"data/schema.csv"}).done(function(t){parsed=Papa.parse(t,{delimiter:"",newline:"",header:!0,dynamicTyping:!0,preview:0}),each(parsed.data,function(t,e){app.schema[e.stat]=e,actualStatSections.push(e.section)}),actualStatSections=unique(actualStatSections),additionalStatSections=_.difference(actualStatSections,idealStatSections),app.orderedStatSections=idealStatSections.concat(additionalStatSections),gettingSchema.resolve()})}function showMap(){mapDisplay=new Datamap({element:document.getElementById("map"),projection:mapProjection,fills:{defaultFill:defaultFillColor},data:app.content,geographyConfig:{popupTemplate:function(t,e){return['<div class="hoverinfo"><strong>',e.name,": "+e[setColorsByStat],"</strong></div>"].join("")},highlightFillColor:highlightColor,highlightBorderColor:highlightBorderColor,highlightBorderWidth:1,highlightBorderOpacity:1},projectionConfig:{rotation:[0,0]}}),mapDisplay.legend(),showingMap.resolve()}function setColorsBy(t,e){app.currentStat=t,e?$("#stats-pane-modifier").show():$("#stats-pane-modifier").hide();var a={},n=[],o,i,s=app.schema[t].type;"verbose"==app.schema[t].type?e?each(e,function(t,e){a[e[1]]=colors(e[0])}):each(app.content,function(e,n){n[t]&&(a[e]=mediumColor)}):(each(app.content,function(e,a){a[t]&&n.push(a[t])}),o=app.schema[t].min?app.schema[t].min:Math.min.apply(null,n),i=app.schema[t].max?app.schema[t].max:Math.max.apply(null,n),chooseColors(o,i,s),e?each(e,function(t,e){a[e[1]]=colors(e[0])}):each(app.content,function(e,n){n[t]&&(a[e]=colors(n[t]))})),mapDisplay.updateChoropleth(a,{reset:!0})}function clearMapColors(){var t={};each(app.content,function(e,a){t[e]=defaultFillColor}),mapDisplay.updateChoropleth(t,{reset:!0})}function populateStatsList(){makeStatsInteractive("#stats-list")}function showStatsList(){$("#stats-info").hide(),$("#stats-list").show(),$("#stats-back-text").hide(),$("#stats-source").html(""),app.statsPaneTitle="Stats"}function formatStatData(t,e){return"percent"==e?numeral(t).format("0[.]00%"):"currency"==e?numeral(t).format("$0,0[.]00"):"number"==e?numeral(t).format("0,0[.]00"):"polities"==e&&app.content[t]?app.content[t].name:t}function displayStatItem(t){var e=formatStatData(t.data,t.type),a="";t.actionable&&(a=a.concat("actionable ")),a=a.concat("stat-"+t.stat+"-data"),$(t.target).append(t.prefix+element({tag:"span",content:e,class:a,data:t.data}))}function showPolityInfo(t){$("#polity-list").hide(),$("#polity-info").empty(),$("#polity-info").show(),$("#polity-back-text").show(),app.polityPaneTitle=app.content[t].name,each(app.content[t],function(e,a){if(app.content[t]){var n;n=app.schema[e]?app.schema[e].title:'"'+e+'"';var o="#polity-info";app.schema[e]&&"Codes"!=app.schema[e].section&&"name"!=e&&a&&($(o).append("<h3 class='actionable stat-"+e+"'>"+n+"</h3>"),"multipleSelect"==app.schema[e].type||"polities"==app.schema[e].type?each(a,function(t,n){var i="";0!=t&&(i=", "),displayStatItem({target:o,prefix:i,actionable:!0,stat:e,data:a,type:app.schema[e].type})}):displayStatItem({target:o,prefix:"",actionable:!0,stat:e,data:a,type:app.schema[e].type}))}}),makePolitiesInteractive("#polity-info"),makeStatsInteractive("#polity-info"),$("#polity-pane").animate({scrollTop:0},0)}function showStatsInfo(t,e,a){$("#stats-list").hide(),$("#stats-info").empty(),$("#stats-info").show(),$("#stats-back-text").show(),app.statsPaneTitle=app.schema[t].title,each(app.content,function(n,o){if(o[t]){var i=formatStatData(o[t],app.schema[t].type);e?"greater"==a&&o[t]>=e?$("#stats-info").append("<h3 class='header actionable "+n+"'>"+o.name+"</h3><div>"+i+"</div>"):"lesser"==a&&o[t]<=e?$("#stats-info").append("<h3 class='header actionable "+n+"'>"+o.name+"</h3><div>"+i+"</div>"):"same"==a&&containsOrEquals(o[t],e)&&$("#stats-info").append("<h3 class='header actionable "+n+"'>"+o.name+"</h3><div>"+i+"</div>"):$("#stats-info").append("<h3 class='header actionable "+n+"'>"+o.name+"</h3><div>"+i+"</div>")}}),makeStatsInteractive("#stats-info"),makePolitiesInteractive("#stats-info"),$("#stats-pane").animate({scrollTop:0},0),showStatsSource(t)}function populatePolitiesList(){app.polities=polities,makePolitiesInteractive("#polity-list")}function showPolitiesList(){$("#polity-info").hide(),$("#polity-list").show(),$("#polity-back-text").hide(),app.polityPaneTitle="Polities"}function showDefaultPolity(){if(defaultPolity)if("random"==defaultPolity){var t=pick(polities);showPolityInfo(t)}else showPolityInfo(defaultPolity)}function makePolitiesInteractive(t){}function makeStatsInteractive(t){}function enableZoom(){var t=d3.behavior.zoom().scaleExtent([1,20]).on("zoom",zoomed);d3.select(".datamap").call(t)}function zoomed(){d3.select(".datamaps-subunits").attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")}function setColorsBySubset(t,e){var a=[];"multipleSelect"==app.schema[t].type||"singleSelect"==app.schema[t].type?(each(polities,function(n,o){containsOrEquals(app.content[o][t],e)&&a.push([app.content[o][t],o]),app.currentDirection="same",$("#stats-pane-modifier").html(e)}),setColorsBy(t,a),showStatsInfo(t,e,app.currentDirection)):(e=numeral(e).value(),formattedLimit=formatStatData(e,app.schema[t].type),t==app.currentStat&&"greater"==app.currentDirection?each(polities,function(n,o){""!=app.content[o][t]&&app.content[o][t]<=e&&a.push([app.content[o][t],o]),app.currentDirection="lesser",$("#stats-pane-modifier").html("&le; "+formattedLimit)}):each(polities,function(n,o){""!=app.content[o][t]&&app.content[o][t]>=e&&a.push([app.content[o][t],o]),app.currentDirection="greater",$("#stats-pane-modifier").html("&ge; "+formattedLimit)}),a.sort(function(t,e){return t[0]-e[0]}),setColorsBy(t,a),showStatsInfo(t,e,app.currentDirection))}function enableNavBar(){$("#polities-nav").click(function(){$(".nav-item").removeClass("current-nav"),$(this).addClass("current-nav"),$("#left").removeClass("narrow-hide"),$("#center").addClass("narrow-hide"),$("#right").addClass("narrow-hide")}),$("#map-nav").click(function(){$(".nav-item").removeClass("current-nav"),$(this).addClass("current-nav"),$("#left").addClass("narrow-hide"),$("#center").removeClass("narrow-hide"),$("#right").addClass("narrow-hide")}),$("#stats-nav").click(function(){$(".nav-item").removeClass("current-nav"),$(this).addClass("current-nav"),$("#left").addClass("narrow-hide"),$("#center").addClass("narrow-hide"),$("#right").removeClass("narrow-hide")})}function showStatsSource(t){$("#lower-right").show();var e=app.schema[t].sourceName,a=app.schema[t].sourceURL;$("#stats-source").html("Source: "+element({tag:"a",content:e,target:"_blank",class:"actionable",href:a}))}$(function(){getData(),getSchema(),enableNavBar()});var csv,colors,polities=[],mapDisplay,app=new Vue({el:"#page",data:{content:{},schema:{},stats:[],statsPaneTitle:"Stats",polityPaneTitle:"Polities",polities:polities,orderedStatSections:[],currentPolity:"",currentStat:"",currentDirection:""},methods:{politySelect:function(t){showPolityInfo(t)},statSelect:function(t){showStatsInfo(t)},polityBack:function(){showPolitiesList()},statBack:function(){showStatsList(),$("#stats-pane-modifier").hide()}}}),idealStatSections=["Naming","Demographics","Economy","Infrastructure","Codes"],actualStatSections=[],additionalStatSections=[],gettingData=$.Deferred(),gettingSchema=$.Deferred();$.when(gettingData,gettingSchema).done(function(t){procesMultipleSelects(),processPercentages(),processNumbers(),showMap(),populateStatsList(),showStatsList(),populatePolitiesList()});var showingMap=$.Deferred().done(function(){makePolitiesInteractive("#map-pane"),enableZoom()});