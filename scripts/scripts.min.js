function changeDirection(){null==app.currentDirection||-1==app.currentDirection?app.currentDirection=1:app.currentDirection=-1}function procesMultipleSelects(){each(app.stats,function(t,e){app.schema[e]&&("multipleSelect"!=app.schema[e].type&&"polities"!=app.schema[e].type||each(app.content,function(t,n){n[e]&&(n[e]=n[e].split(","))}))})}function processPercentages(){each(app.stats,function(t,e){app.schema[e]&&"percent"==app.schema[e].type&&each(app.content,function(t,n){n[e]&&Math.round(n[e]=n[e]/100).toFixed(2)})})}function processNumbers(){each(app.stats,function(t,e){app.schema[e]&&("number"!=app.schema[e].type&&"currency"!=app.schema[e].type||each(app.content,function(t,n){n[e]&&(n[e]=numeral(n[e]).value())}))})}function chooseColors(t,e,n){colors="index"==n||"number"==n||"percent"==n||"currency"==n?d3.scale.linear().domain([t,e]).range([lightColor,darkColor]):"rank"==n?d3.scale.linear().domain([t,e]).range([darkColor,lightColor]):"singleSelect"==TypeError?d3.scale.category20b():"verbose"==n||"code"==n?function(){return mediumColor}:"multipleSelect"==n?function(){return mediumDarkColor}:d3.scale.category20b()}function getData(){$.ajax({url:"data/polities.csv"}).done(function(t){app.stats=Papa.parse(t,{delimiter:"",newline:"",dynamicTyping:!0,preview:1}).data[0],parsed=Papa.parse(t,{delimiter:"",newline:"",header:!0,dynamicTyping:!0,preview:0});var e=[];each(parsed.data,function(t,n){app.content[n[iDColumnHeader]]=n,e.push([n.name,n[iDColumnHeader]])}),e.sort(function(t,e){return t[0]===e[0]?0:t[0]<e[0]?-1:1}),each(e,function(t,e){app.polities.push(e[1])}),gettingData.resolve()})}function getSchema(){$.ajax({url:"data/schema.csv"}).done(function(t){parsed=Papa.parse(t,{delimiter:"",newline:"",header:!0,dynamicTyping:!0,preview:0}),each(parsed.data,function(t,e){app.schema[e.stat]=e,actualStatSections.push(e.section)}),actualStatSections=unique(actualStatSections),additionalStatSections=_.difference(actualStatSections,firstStatSections),app.orderedStatSections=firstStatSections.concat(additionalStatSections),gettingSchema.resolve()})}function showMap(){mapDisplay=new Datamap({element:document.getElementById("map"),projection:mapProjection,fills:{defaultFill:defaultFillColor},data:app.content,geographyConfig:{popupTemplate:function(t,e){return['<div class="hoverinfo"><strong>',e.name,": "+e[setColorsByStat],"</strong></div>"].join("")},highlightFillColor:highlightColor,highlightBorderColor:highlightBorderColor,highlightBorderWidth:1,highlightBorderOpacity:1},projectionConfig:{rotation:[0,0]},done:function(t){t.svg.selectAll(".datamaps-subunit").on("click",function(t){showPolityInfo(t.id)})}}),mapDisplay.legend(),showingMap.resolve()}function setColorsBy(t,e){app.currentStat=t;var n={},a=[],r,i,o=app.schema[t].type;"verbose"==app.schema[t].type?e?each(e,function(t,e){n[e[1]]=colors(e[0])}):each(app.content,function(e,a){a[t]&&(n[e]=mediumColor)}):(each(app.content,function(e,n){n[t]&&a.push(n[t])}),r=app.schema[t].min?app.schema[t].min:Math.min.apply(null,a),i=app.schema[t].max?app.schema[t].max:Math.max.apply(null,a),chooseColors(r,i,o),e?each(e,function(t,e){n[e[1]]=colors(e[0])}):each(app.content,function(e,a){a[t]&&(n[e]=colors(a[t]))})),mapDisplay.updateChoropleth(n,{reset:!0})}function clearMapColors(){var t={};each(app.content,function(e,n){t[e]=defaultFillColor}),mapDisplay.updateChoropleth(t,{reset:!0})}function showStatsList(){app.currentStat=null,scrollUp("#middle-right"),$("#stats-source").html("")}function formatStatData(t,e){return"percent"==e?numeral(t).format("0[.]00%"):"currency"==e?numeral(t).format("$0,0[.]00"):"number"==e?numeral(t).format("0,0[.]00"):"polities"==e&&app.content[t]?app.content[t].name:t}function displayStatItem(t){var e=formatStatData(t.data,t.type),n="";t.actionable&&(n=n.concat("actionable ")),n=n.concat("stat-"+t.stat+"-data"),$(t.target).append(t.prefix+element({tag:"span",content:e,class:n,data:t.data}))}function showPolityInfo(t){scrollUp("#middle-left"),app.currentPolity=t}function scrollUp(t){$(t).animate({scrollTop:0},0)}function showStatsInfo(t,e,n){app.currentStat=t,scrollUp("#middle-right"),setColorsBy(t),showStatsSource(t)}function showPolitiesList(){app.currentPolity=null,scrollUp("#middle-left")}function showDefaultPolity(){if(defaultPolity)if("random"==defaultPolity){var t=pick(app.polities);showPolityInfo(t)}else showPolityInfo(defaultPolity)}function enableZoom(){var t=d3.behavior.zoom().scaleExtent([1,20]).on("zoom",zoomed);d3.select(".datamap").call(t)}function zoomed(){d3.select(".datamaps-subunits").attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")}function setColorsBySubset(t,e){var n=[];"multipleSelect"==app.schema[t].type||"singleSelect"==app.schema[t].type?(each(app.polities,function(a,r){containsOrEquals(app.content[r][t],e)&&n.push([app.content[r][t],r]),app.currentDirection="same"}),setColorsBy(t,n),showStatsInfo(t,e,app.currentDirection)):(e=numeral(e).value(),formattedLimit=formatStatData(e,app.schema[t].type),t==app.currentStat&&"greater"==app.currentDirection?each(app.polities,function(a,r){""!=app.content[r][t]&&app.content[r][t]<=e&&n.push([app.content[r][t],r]),app.currentDirection="lesser"}):each(app.polities,function(a,r){""!=app.content[r][t]&&app.content[r][t]>=e&&n.push([app.content[r][t],r]),app.currentDirection="greater"}),n.sort(function(t,e){return t[0]-e[0]}),setColorsBy(t,n),showStatsInfo(t,e,app.currentDirection))}function showStatsSource(t){var e=app.schema[t].sourceName,n=app.schema[t].sourceURL;$("#stats-source").html("Source: "+element({tag:"a",content:e,target:"_blank",class:"actionable",href:n}))}function showDebug(){app.showDebug=!0}function hideDebug(){app.showDebug=!1}$(function(){getData(),getSchema()});var csv,colors,mapDisplay,app=new Vue({el:"#app",data:{content:{},schema:{},stats:[],strings:strings,polities:[],orderedStatSections:[],currentPolity:null,currentStat:null,currentLimit:null,currentDirection:null,showDebug:!1,currentView:"map"},methods:{politySelect:function(t){showPolityInfo(t)},statSelect:function(t){showStatsInfo(t),this.currentLimit=null,this.currentDirection=null},polityBack:function(){showPolitiesList()},statBack:function(){showStatsList()},statSelectWithLimit:function(t,e){showStatsInfo(t),this.currentLimit=e,changeDirection()},filterStatItem:function(t){return null==this.currentLimit||(this.currentStatIsNumeric?!(this.currentLimit||!this.currentStatsInfo[t])||!!(this.currentStatsInfo[t]*this.currentDirection>this.currentLimit*this.currentDirection&&this.currentLimit):1==this.currentDirection&&this.currentLimit==this.currentStatsInfo[t]||-1==this.currentDirection&&this.currentLimit!=this.currentStatsInfo[t])}},computed:{currentStatType:function(){var t="";return this.schema[this.currentStat]&&(t=this.schema[this.currentStat].type),t},currentPolityInfo:function(){var t={};return this.currentPolity&&(t=this.content[this.currentPolity]),t},currentPolityInfoFormatted:function(){var t={};return each(this.currentPolityInfo,function(e,n){var a="";app.schema[e]&&(a=app.schema[e].type),t[e]=formatStatData(n,a)}),t},currentStatsInfo:function(){var t={};return this.currentStat&&each(this.polities,function(e,n){t[n]=app.content[n][app.currentStat]}),t},currentStatsInfoFormatted:function(){var t={},e=this.currentStatType;return each(this.currentStatsInfo,function(n,a){t[n]=formatStatData(a,e)}),t},currentPolityName:function(){if(this.currentPolity)return this.currentPolityInfo.name},currentStatName:function(){if(this.schema[this.currentStat])return this.schema[this.currentStat].title},polityPaneTitle:function(){return this.currentPolity?this.currentPolityName:this.strings.polityPaneTitle},statsPaneTitle:function(){return this.currentStat?this.currentStatName:this.strings.statsPaneTitle},currentLimitFormatted:function(){return null==this.currentLimit?null:formatStatData(this.currentLimit,this.currentStatType)},currentStatIsNumeric:function(){return null==this.currentStatType?null:"index"==this.currentStatType||"number"==this.currentStatType||"percent"==this.currentStatType||"currency"==this.currentStatType||"rank"==this.currentStatType||("singleSelect"==this.currentStatType||"verbose"==this.currentStatType||"code"==this.currentStatType||this.currentStatType,!1)}}}),firstStatSections=["Naming","Demographics","Economy","Infrastructure"],actualStatSections=[],additionalStatSections=[],gettingData=$.Deferred(),gettingSchema=$.Deferred();$.when(gettingData,gettingSchema).done(function(t){procesMultipleSelects(),processPercentages(),processNumbers(),showMap(),showStatsList()});var showingMap=$.Deferred().done(function(){enableZoom()});$(".debugX").click(function(){hideDebug()});